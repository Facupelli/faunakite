---
export const prerender = false;

import { actions, isInputError } from "astro:actions";
import Layout from "../../layouts/Layout.astro";
import {
  CourseType,
  DetailedSkillLevel,
  Gender,
  ReferralSource,
  SkillLevel,
} from "../../modules/booking/booking.entity";
import { useTranslations, useEnumTranslations } from "../../i18n/utils";
import { Image } from "astro:assets";
import logo from "../../assets/logos/logo-blanco-03.png";

const lang = Astro.params.locale as "en" | "es";
const t = useTranslations(lang);
const enumT = useEnumTranslations(lang);

const result = Astro.getActionResult(actions.book.createBooking);
const inputErrors = isInputError(result?.error) ? result.error.fields : {};

const TURNSTILE_BOOKED_SITE_KEY = "0x4AAAAAACEmkC__Q9DUyDof";

if (result && !result.error) {
  return Astro.redirect(`/${lang}/booked-success`);
}
---

<Layout>
  <Fragment slot="head">
    <link rel="preconnect" href="https://challenges.cloudflare.com" />
  </Fragment>

  <main class="bg-brand-blue min-h-dvh">
    <div class="text-center py-10 space-y-2">
      <h1 class="text-xl mb-0">{t("booked.title")}</h1>
      <div class="flex justify-center">
        <div
          class="relative w-full max-w-[150px] aspect-[3.45/1] flex items-center justify-center"
        >
          <Image decoding="async" src={logo} alt="Logo FaunaKite white" />
        </div>
      </div>
    </div>

    <div class="max-w-3xl mx-auto px-4">
      <div class="space-y-2">
        <p>
          {t("booked.summary.1")} üèÑüèº‚Äç‚ôÇÔ∏èüèÑüèº‚Äç‚ôÄÔ∏èü™Å
        </p>
        <p>
          {t("booked.summary.2")} üå¨Ô∏èüèúÔ∏è
        </p>
        <p>
          {t("booked.summary.3")} ‚è≥
        </p>
      </div>
    </div>

    <form
      class="max-w-3xl mx-auto px-4 py-8 space-y-6 text-black"
      method="POST"
      action={actions.book.createBooking}
      enctype="multipart/form-data"
      id="booked-form"
    >
      <!-- Error Messages -->
      {
        result?.error && (
          <div class="mt-6">
            <div
              id="error-message"
              class="p-4 bg-red-50 border border-red-200 rounded-lg"
            >
              <div class="flex">
                <div class="shrink-0">
                  <svg
                    class="h-5 w-5 text-red-400"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-bold text-red-800">
                    {t("booked.error.title")}
                  </h3>
                  {result.error.code === "INTERNAL_SERVER_ERROR" && (
                    <div class="mt-2 text-sm text-red-700" id="error-details">
                      {result.error.message}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )
      }

      <section class="bg-white rounded-lg shadow-md p-2 md:p-6">
        <div class="flex items-center gap-3 mb-6">
          <span
            class="bg-brand-green text-white size-8 shrink-0 rounded-full flex items-center justify-center font-bold"
            >1</span
          >
          <h2 class="text-xl md:text-2xl font-bold text-gray-800 uppercase">
            {t("booked.section1.title")}
          </h2>
        </div>

        <div class="space-y-4">
          <div>
            <label
              for="customerName"
              class="block text-sm font-bold text-gray-700 mb-1"
            >
              {t("booked.section1.field.customerName.label")}
              <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="customerName"
              name="customerName"
              transition:persist
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <div>
            <label
              for="birthDate"
              class="block text-sm font-bold text-gray-700 mb-1"
            >
              {t("booked.section1.field.birthDate.label")}
              <span class="text-red-500">*</span>
            </label>
            <input
              type="date"
              id="birthDate"
              name="birthDate"
              transition:persist
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">
              {t("booked.section1.field.gender.label")}
            </label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input
                  transition:persist
                  type="radio"
                  name="gender"
                  value={Gender.MALE}
                  class="mr-2"
                />
                <span>{enumT("gender.male")}</span>
              </label>
              <label class="flex items-center">
                <input
                  transition:persist
                  type="radio"
                  name="gender"
                  value={Gender.FEMALE}
                  class="mr-2"
                />
                <span>{enumT("gender.female")}</span>
              </label>
            </div>
          </div>

          <div>
            <label
              for="customerEmail"
              class="block text-sm font-bold text-gray-700 mb-1"
            >
              {t("booked.section1.field.customerEmail.label")}
              <span class="text-red-500">*</span>
            </label>
            <input
              transition:persist
              type="email"
              id="customerEmail"
              name="customerEmail"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            {
              inputErrors.customerEmail && (
                <p class="text-red-600 text-sm pt-1">
                  {inputErrors.customerEmail.join(",")}
                </p>
              )
            }
          </div>

          <div>
            <label
              for="province"
              class="block text-sm font-bold text-gray-700 mb-1"
            >
              {t("booked.section1.field.province.label")}
              <span class="text-red-500">*</span>
            </label>
            <input
              transition:persist
              type="text"
              id="province"
              name="province"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <div>
            <label
              for="customerPhone"
              class="block text-sm font-bold text-gray-700 mb-1"
            >
              {t("booked.section1.field.customerPhone.label")}
            </label>
            <input
              transition:persist
              type="tel"
              id="customerPhone"
              name="customerPhone"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>
      </section>

      <section class="bg-white rounded-lg shadow-md p-2 md:p-6">
        <div class="flex items-center gap-3 mb-6">
          <span
            class="bg-brand-green text-white size-8 shrink-0 rounded-full flex items-center justify-center font-bold"
            >2</span
          >
          <h2 class="text-xl md:text-2xl font-bold text-gray-800 uppercase">
            {t("booked.section2.title")}
          </h2>
        </div>

        <div class="space-y-4">
          <div>
            <label
              for="courseType"
              class="block text-sm font-bold text-gray-700 mb-1"
            >
              {t("booked.section2.field.courseType.label")}
            </label>
            <select
              transition:persist
              id="courseType"
              name="courseType"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            >
              <!-- TODO: improve coupling with enums and translations-->
              <option value="">
                {t("booked.section2.field.courseType.placeholder")}
              </option>
              <option value={CourseType.INDIVIDUAL}>
                {enumT("courseType.individual")}
              </option>
              <option value={CourseType.DOUBLE}
                >{enumT("courseType.double")}</option
              >
              <option value={CourseType.INTENSIVE}
                >{enumT("courseType.intensive")}</option
              >
              <option value={CourseType.INDIVIDUAL_CLASS}
                >{enumT("courseType.individual_class")}</option
              >
              <option value={CourseType.ADVANCED}
                >{enumT("courseType.advanced")}</option
              >
              <option value={CourseType.TEST}>{enumT("courseType.test")}</option
              >
              <option value={CourseType.GUEST}
                >{enumT("courseType.guest")}</option
              >
              <option value={CourseType.EQUIPMENT_RENTAL}
                >{enumT("courseType.equipmentRental")}</option
              >
            </select>
          </div>

          <div>
            <label
              for="hoursReserved"
              class="block text-sm font-bold text-gray-700 mb-1"
            >
              {t("booked.section2.field.hoursReserved.label")}
            </label>
            <input
              transition:persist
              type="number"
              id="hoursReserved"
              name="hoursReserved"
              min="1"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="arrivalDate"
                class="block text-sm font-bold text-gray-700 mb-1"
              >
                {t("booked.section2.field.arrivalDate.label")}
                <span class="text-red-500">*</span>
              </label>
              <input
                transition:persist
                type="date"
                id="arrivalDate"
                name="arrivalDate"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              />
              {
                inputErrors.arrivalDate && (
                  <p class="text-red-600 text-sm pt-1">
                    {inputErrors.arrivalDate.join(",")}
                  </p>
                )
              }
            </div>

            <div>
              <label
                for="arrivalTime"
                class="block text-sm font-bold text-gray-700 mb-1"
              >
                {t("booked.section2.field.arrivalTime.label")}
                <span class="text-red-500">*</span>
              </label>
              <input
                transition:persist
                type="time"
                id="arrivalTime"
                name="arrivalTime"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="departureDate"
                class="block text-sm font-bold text-gray-700 mb-1"
              >
                {t("booked.section2.field.departureDate.label")}
                <span class="text-red-500">*</span>
              </label>
              <input
                transition:persist
                type="date"
                id="departureDate"
                name="departureDate"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              />
              {
                inputErrors.departureDate && (
                  <p class="text-red-600 text-sm pt-1">
                    {inputErrors.departureDate.join(",")}
                  </p>
                )
              }
            </div>

            <div>
              <label
                for="departureTime"
                class="block text-sm font-bold text-gray-700 mb-1"
              >
                {t("booked.section2.field.departureTime.label")}
              </label>
              <input
                transition:persist
                type="time"
                id="departureTime"
                name="departureTime"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
              />
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-lg shadow-md p-2 md:p-6">
        <div class="flex items-center gap-3 mb-6">
          <span
            class="bg-brand-green text-white size-8 shrink-0 rounded-full flex items-center justify-center font-bold"
            >3</span
          >
          <h2 class="text-xl md:text-2xl font-bold text-gray-800 uppercase">
            {t("booked.section3.title")}
          </h2>
        </div>

        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="weightKg"
                class="block text-sm font-bold text-gray-700 mb-1"
              >
                {t("booked.section3.field.weightKg.label")}
              </label>
              <input
                transition:persist
                type="number"
                id="weightKg"
                name="weightKg"
                min="1"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label
                for="heightCm"
                class="block text-sm font-bold text-gray-700 mb-1"
              >
                {t("booked.section3.field.heightCm.label")}
              </label>
              <input
                transition:persist
                type="number"
                id="heightCm"
                name="heightCm"
                min="1"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">
              {t("booked.section3.field.currentLevel.label")}
            </label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input
                  transition:persist
                  type="radio"
                  name="currentLevel"
                  value={SkillLevel.BEGINNER}
                  class="mr-2"
                />
                <span>{enumT("skillLevel.beginner")}</span>
              </label>
              <label class="flex items-center">
                <input
                  transition:persist
                  type="radio"
                  name="currentLevel"
                  value={SkillLevel.INTERMEDIATE}
                  class="mr-2"
                />
                <span>{enumT("skillLevel.intermediate")}</span>
              </label>
              <label class="flex items-center">
                <input
                  transition:persist
                  type="radio"
                  name="currentLevel"
                  value={SkillLevel.ADVANCED}
                  class="mr-2"
                />
                <span>{enumT("skillLevel.advanced")}</span>
              </label>
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-lg shadow-md p-2 md:p-6">
        <div class="flex items-center gap-3 mb-6">
          <span
            class="bg-brand-green text-white size-8 shrink-0 rounded-full flex items-center justify-center font-bold"
            >4</span
          >
          <h2 class="text-xl md:text-2xl font-bold text-gray-800 uppercase">
            {t("booked.section4.title")}
          </h2>
        </div>

        <div>
          <label class="block text-sm font-bold text-gray-700 mb-3">
            {t("booked.section4.field.detailedSkillLevel.label")}
          </label>
          <div class="space-y-2">
            <label class="flex items-start">
              <input
                transition:persist
                type="radio"
                name="detailedSkillLevel"
                value={DetailedSkillLevel.THEORY_AND_SAFETY}
                class="mr-2 mt-1"
              />
              <span>{enumT("detailedSkillLevel.theoryAndSafety")}</span>
            </label>
            <label class="flex items-start">
              <input
                transition:persist
                type="radio"
                name="detailedSkillLevel"
                value={DetailedSkillLevel.BODY_DRAGS}
                class="mr-2 mt-1"
              />
              <span>{enumT("detailedSkillLevel.bodyDrags")}</span>
            </label>
            <label class="flex items-start">
              <input
                transition:persist
                type="radio"
                name="detailedSkillLevel"
                value={DetailedSkillLevel.WATER_START}
                class="mr-2 mt-1"
              />
              <span>{enumT("detailedSkillLevel.waterStart")}</span>
            </label>
            <label class="flex items-start">
              <input
                transition:persist
                type="radio"
                name="detailedSkillLevel"
                value={DetailedSkillLevel.SHORT_RIDES}
                class="mr-2 mt-1"
              />
              <span>{enumT("detailedSkillLevel.shortRides")}</span>
            </label>
            <label class="flex items-start">
              <input
                transition:persist
                type="radio"
                name="detailedSkillLevel"
                value={DetailedSkillLevel.NAVIGATION_WITH_DRIFT}
                class="mr-2 mt-1"
              />
              <span>{enumT("detailedSkillLevel.navigationWithDrift")}</span>
            </label>
            <label class="flex items-start">
              <input
                transition:persist
                type="radio"
                name="detailedSkillLevel"
                value={DetailedSkillLevel.UPWIND_LEARNING_TRANSITIONS}
                class="mr-2 mt-1"
              />
              <span
                >{enumT("detailedSkillLevel.upwindLearningTransitions")}</span
              >
            </label>
            <label class="flex items-start">
              <input
                transition:persist
                type="radio"
                name="detailedSkillLevel"
                value={DetailedSkillLevel.TRANSITIONS}
                class="mr-2 mt-1"
              />
              <span>{enumT("detailedSkillLevel.transitions")}</span>
            </label>
            <label class="flex items-start">
              <input
                transition:persist
                type="radio"
                name="detailedSkillLevel"
                value={DetailedSkillLevel.SMALL_JUMPS}
                class="mr-2 mt-1"
              />
              <span>{enumT("detailedSkillLevel.smallJumps")}</span>
            </label>
            <label class="flex items-start">
              <input
                transition:persist
                type="radio"
                name="detailedSkillLevel"
                value={DetailedSkillLevel.CONTROLLED_JUMPS_AND_MANEUVERS}
                class="mr-2 mt-1"
              />
              <span
                >{enumT("detailedSkillLevel.controlledJumpsAndManeuvers")}</span
              >
            </label>
          </div>
        </div>
      </section>

      {/* Section 5: OBJETIVOS Y PREFERENCIAS */}
      <section class="bg-white rounded-lg shadow-md p-2 md:p-6">
        <div class="flex items-center gap-3 mb-6">
          <span
            class="bg-brand-green text-white size-8 shrink-0 rounded-full flex items-center justify-center font-bold"
            >5</span
          >
          <h2 class="text-xl md:text-2xl font-bold text-gray-800 uppercase">
            {t("booked.section5.title")}
          </h2>
        </div>

        <p class="text-gray-600 mb-4">{t("booked.section5.intro")}</p>

        <div class="space-y-4">
          <div>
            <label
              for="mainObjective"
              class="block text-sm font-bold text-gray-700 mb-1"
            >
              {t("booked.section5.field.mainObjective.label")}
            </label>
            <textarea
              transition:persist
              id="mainObjective"
              name="mainObjective"
              rows={3}
              placeholder={t("booked.section5.field.mainObjective.placeholder")}
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            ></textarea>
          </div>

          <div>
            <label
              for="additionalNotes"
              class="block text-sm font-bold text-gray-700 mb-1"
            >
              {t("booked.section5.field.additionalNotes.label")}
            </label>
            <textarea
              transition:persist
              id="additionalNotes"
              name="additionalNotes"
              rows={4}
              placeholder={t(
                "booked.section5.field.additionalNotes.placeholder"
              )}
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            ></textarea>
          </div>
        </div>
      </section>

      {/* Section 6: Para terminar */}
      <section class="bg-white rounded-lg shadow-md p-2 md:p-6">
        <div class="flex items-center gap-3 mb-6">
          <span
            class="bg-brand-green text-white size-8 shrink-0 rounded-full flex items-center justify-center font-bold"
            >6</span
          >
          <h2 class="text-xl md:text-2xl font-bold text-gray-800 uppercase">
            {t("booked.section6.title")}
          </h2>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">
              {t("booked.section6.field.referralSource.label")}
            </label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input
                  transition:persist
                  type="radio"
                  name="referralSource"
                  value={ReferralSource.INSTAGRAM}
                  class="mr-2"
                />
                <span>Instagram</span>
              </label>
              <label class="flex items-center">
                <input
                  transition:persist
                  type="radio"
                  name="referralSource"
                  value={ReferralSource.GOOGLE}
                  class="mr-2"
                />
                <span>Google</span>
              </label>
              <label class="flex items-center">
                <input
                  transition:persist
                  type="radio"
                  name="referralSource"
                  value={ReferralSource.RECOMMENDATION}
                  class="mr-2"
                />
                <span>{enumT("referralSource.recommendation")}</span>
              </label>
              <label class="flex items-center">
                <input
                  transition:persist
                  type="radio"
                  name="referralSource"
                  value={ReferralSource.CUESTA_DEL_VIENTO}
                  class="mr-2"
                />
                <span>{enumT("referralSource.cuesta_del_viento")}</span>
              </label>
              <label class="flex items-center">
                <input
                  transition:persist
                  type="radio"
                  name="referralSource"
                  value={ReferralSource.OTHER}
                  class="mr-2"
                />
                <span>{enumT("referralSource.other")}</span>
              </label>
            </div>
            <input
              transition:persist
              type="text"
              name="referralSourceOther"
              placeholder="Si elegiste 'Otro', especific√° aqu√≠"
              class="mt-2 w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-cyan-500 focus:border-transparent"
            />
          </div>

          <div>
            <label class="flex items-start">
              <input
                transition:persist
                type="checkbox"
                name="newsletterOptIn"
                class="mr-2 mt-1"
              />
              <span class="text-sm text-gray-700">
                {t("booked.section6.field.newsLetterOptIn.label")}
              </span>
            </label>
          </div>
        </div>
      </section>

      <div
        class="bg-linear-to-r from-celeste-3 to-celeste-2 rounded-lg shadow-lg p-8 text-center text-white"
      >
        <p class="text-lg mb-4">
          {t("booked.footer.message")}
        </p>

        <div
          class="cf-turnstile"
          data-sitekey={TURNSTILE_BOOKED_SITE_KEY}
          data-theme="light"
          data-size="normal"
        >
        </div>

        <button
          type="submit"
          id="booking-submit-btn"
          class="bg-white cursor-pointer text-brand-blue font-bold px-8 py-3 rounded-lg hover:bg-gray-100 transition-colors duration-200 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span class="button-text">{t("booked.footer.submit")}</span>
          <span class="button-loading hidden">
            <svg
              class="inline-block animate-spin h-5 w-5 mr-2"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            {t("booked.footer.submitting")}
          </span>
        </button>
      </div>
    </form>
  </main>
</Layout>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer
></script>

<script>
  const form = document.getElementById("booked-form") as HTMLFormElement;
  const submitBtn = document.getElementById(
    "booking-submit-btn"
  ) as HTMLButtonElement;

  if (form && submitBtn) {
    form.addEventListener("submit", function (e) {
      submitBtn.disabled = true;

      const buttonText = submitBtn.querySelector(".button-text");
      const buttonLoading = submitBtn.querySelector(".button-loading");

      if (buttonText && buttonLoading) {
        buttonText.classList.add("hidden");
        buttonLoading.classList.remove("hidden");
      }

      // Form will submit naturally (no preventDefault)
    });
  }
</script>
