---
import type { InferGetStaticParamsType } from "astro";
import { PortableText } from "astro-portabletext";
import {
  getNewsBySlug,
  getNews,
  type News,
  getLatestNews,
} from "../../../modules/news/utils";
import Layout from "../../../layouts/Layout.astro";
import Seo from "../../../components/seo.astro";
import { urlFor } from "../../../modules/news/image.utils";
import { formatDate } from "../../../modules/news/date.utils";
import Nav from "../../../components/nav.astro";
import Footer from "../../../components/footer.astro";
import { useTranslations } from "../../../i18n/utils";
import NewsCarousel from "../../../components/news/news-carousel";

export async function getStaticPaths() {
  const languages = ["es", "en"] as const;
  const paths = [];

  for (const locale of languages) {
    const posts = await getNews(locale);

    paths.push(
      ...posts.map((post) => ({
        params: {
          locale,
          slug: post.slug.current,
        },
      })),
    );
  }

  return paths;
}

type Params = InferGetStaticParamsType<typeof getStaticPaths>;
const { slug, locale } = Astro.params as Params;
const lang = locale as "en" | "es";

const t = useTranslations(lang);

const post = await getNewsBySlug(slug, lang);
const posts: News[] = await getLatestNews(lang);

const morePosts: News[] = posts.filter((post) => post.slug.current !== slug);

function getOptimizedImageUrl(
  image: any,
  width: number,
  format: "webp" = "webp",
) {
  return urlFor(image).width(width).format(format).quality(85).url();
}

function generateSrcSet(image: any, format: "webp" = "webp") {
  const sizes = [400, 600, 800, 1000];
  return sizes
    .map((size) => `${getOptimizedImageUrl(image, size, format)} ${size}w`)
    .join(", ");
}

if (!post) {
  return Astro.redirect(`/${lang}/news`);
}
---

<Layout title={`${post?.title || "News"} | Fauna Kite`} locale={lang}>
  <Fragment slot="head">
    <Seo />
    {
      post?.images && (
        <>
          <link
            rel="preload"
            as="image"
            href={getOptimizedImageUrl(post.images[0], 800, "webp")}
            type="image/webp"
            imagesrcset={generateSrcSet(post.images[0], "webp")}
            imagesizes="(max-width: 768px) 100vw, 50vw"
          />
        </>
      )
    }
  </Fragment>

  <header>
    <Nav />
  </header>

  <main>
    <div class="text-brand-blue">
      <div
        class="relative bg-brand-light min-h-dvh bg-[url('/cuesta-del-viento/white-wave-contrast-2.png')] bg-size-[42px_auto]"
      >
        <div class="max-w-7xl mx-auto pb-20 pt-28 md:pt-40 px-4">
          <div class="flex flex-col md:flex-row gap-y-20">
            <article class="md:basis-[75%] md:max-w-prose md:mx-auto">
              <h1 class="font-bold text-4xl md:text-5xl font-salted uppercase">
                {post.title}
              </h1>
              <p class="text-sm text-brand-blue/80">
                {formatDate(post._createdAt)}
              </p>
              <p class="py-4">{post.summary}</p>

              {
                post.ctaButton?.url != undefined && (
                  <div>
                    <a
                      href={post.ctaButton.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="bg-brand-red px-4 py-2 rounded-3xl text-white text-sm font-semibold"
                    >
                      {post.ctaButton?.text}
                    </a>
                  </div>
                )
              }

              <div class="py-4">
                {
                  post.images && post.images.length > 0 ? (
                    post.images.length === 1 ? (
                      // Single image - original behavior
                      <div>
                        <div class="relative h-80 w-full">
                          <picture>
                            {/* WebP - good compression with broad support */}
                            <source
                              type="image/webp"
                              srcset={generateSrcSet(post.images[0], "webp")}
                              sizes="(max-width: 768px) 100vw, 50vw"
                            />
                            {/* Fallback */}
                            <img
                              src={getOptimizedImageUrl(post.images[0], 800)}
                              srcset={generateSrcSet(post.images[0])}
                              sizes="(max-width: 768px) 100vw, 50vw"
                              alt={post.images[0].alt || post.title}
                              width="800"
                              height="800"
                              class="object-cover w-full h-full rounded-2xl"
                            />
                          </picture>
                        </div>
                        {post.epigraph && (
                          <p class="text-brand-blue/80 text-sm p-2">
                            {post.epigraph}
                          </p>
                        )}
                      </div>
                    ) : (
                      // Multiple images - Carousel
                      <div class="relative w-full">
                        <NewsCarousel client:load images={post.images} />
                        {post.epigraph && (
                          <p class="text-brand-blue/80 text-sm py-2">
                            {post.epigraph}
                          </p>
                        )}
                      </div>
                    )
                  ) : (
                    // No images
                    <div class="post__cover--none" />
                  )
                }
              </div>

              <div class="text-justify">
                <PortableText value={post.body} />
              </div>

              {
                post.ctaButton?.url != undefined && (
                  <div class="pt-4">
                    <a
                      href={post.ctaButton.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="bg-brand-blue px-4 py-2 rounded-3xl text-white text-sm font-semibold"
                    >
                      {post.ctaButton?.text}
                    </a>
                  </div>
                )
              }
            </article>

            <aside class="md:basis-[25%] space-y-4">
              <p class="font-bold text-xl font-salted">{t("news.more-news")}</p>
              <div class="grid gap-10">
                {
                  morePosts.length >= 1 &&
                    morePosts.map((post) => (
                      <article class="w-full h-full text-brand-blue rounded-md overflow-hidden bg-white group cursor-pointer flex">
                        <div class="p-4 space-y-2 basis-2/3">
                          <h3 class="pt-2 text-xl">
                            <a
                              href={`/post/${post.slug.current}`}
                              class="line-clamp-2"
                            >
                              {post.title}
                            </a>
                          </h3>

                          <p class="text-xs text-gray-600">
                            {formatDate(post._createdAt)}
                          </p>

                          <div class="">
                            <a
                              class="text-brand-red hover:underline"
                              href={`/${lang}/news/${post.slug.current}`}
                            >
                              Ver m√°s
                            </a>
                          </div>
                        </div>

                        {post.images && post.images.length > 0 ? (
                          <div class="relative basis-1/3 h-40 overflow-hidden">
                            <img
                              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                              src={getOptimizedImageUrl(post.images[0], 200)}
                              loading="lazy"
                              alt={post.images[0].alt}
                            />
                          </div>
                        ) : (
                          <div class="w-full h-[231px] bg-black" />
                        )}
                      </article>
                    ))
                }
              </div>
            </aside>
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>
