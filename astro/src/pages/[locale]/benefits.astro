---
import { getAllies } from "../../modules/allies/utils";
import Footer from "../../components/footer.astro";
import Nav from "../../components/nav.astro";
import Layout from "../../layouts/Layout.astro";
import { urlFor } from "../../modules/news/image.utils";
import TheSpotTopSeparator from "../../components/svg/the-spot-top-separator.astro";
import AboutUsUnderSeparator from "../../components/svg/about-us-under-separator.astro";
import { useTranslations } from "../../i18n/utils";
import { Icon } from "astro-icon/components";

export async function getStaticPaths() {
  return [{ params: { locale: "en" } }, { params: { locale: "es" } }];
}

const lang = Astro.params.locale as "en" | "es";
const t = useTranslations(lang);

const allies = await getAllies(lang);

const categories = [
  {
    value: "lodging",
    label: lang === "en" ? "Accommodations" : "Alojamientos",
  },
  {
    value: "restaurant",
    label: lang === "en" ? "Restaurants" : "Restaurantes",
  },
  { value: "other", label: lang === "en" ? "Other" : "Otros" },
];

const alliesByCategory = categories
  .map((cat) => ({
    ...cat,
    allies: allies.filter((ally) => ally.category === cat.value),
  }))
  .filter((cat) => cat.allies.length > 0);

function getOptimizedImageUrl(
  image: any,
  width: number,
  format: "webp" = "webp",
) {
  return urlFor(image).width(width).format(format).quality(85).url();
}

function generateSrcSet(image: any, format: "webp" = "webp") {
  const sizes = [400, 600, 800, 1000];
  return sizes
    .map((size) => `${getOptimizedImageUrl(image, size, format)} ${size}w`)
    .join(", ");
}
---

<Layout title="Fauna Aliados">
  <Fragment slot="head">
    <meta
      name="description"
      content="Aliados Fauna: hoteles, restaurantes y experiencias recomendadas en Cuesta del Viento y alrededores. Beneficios exclusivos para alumnos FAUNA y una red de amigos que comparten el espíritu del kite y la buena energía."
    />

    {
      allies[0]?.image && (
        <>
          <link
            rel="preload"
            as="image"
            href={getOptimizedImageUrl(allies[0].image, 800, "webp")}
            type="image/webp"
            imagesrcset={generateSrcSet(allies[0].image, "webp")}
            imagesizes="(max-width: 768px) 100vw, 50vw"
          />
        </>
      )
    }

    <!-- performance -->
    <link
      rel="preload"
      href="/headers/header-1.webp"
      as="image"
      fetchpriority="high"
    />
  </Fragment>

  <header>
    <Nav />
  </header>

  <main class="min-h-dvh bg-brand-light">
    <div class="relative w-full h-[220px] md:h-[300px]">
      <div
        class="absolute inset-0 bg-no-repeat bg-position-[bottom_60%_right_20%] bg-cover"
        style="background-image: url('/headers/header-1.webp');"
      >
      </div>

      <div
        class="flex justify-center max-w-4xl mx-auto relative z-20 h-full items-end pb-4 md:pb-10"
      >
        <h1
          class="font-salted text-shadow-2xs text-shadow-brand-blue text-6xl md:text-8xl pr-4 md:pr-0"
        >
          {t("ally.title")}
        </h1>
      </div>

      <div class="absolute bottom-0 left-0 w-full text-brand-blue">
        <TheSpotTopSeparator />
      </div>
    </div>

    <div class="bg-brand-blue">
      <div class="max-w-6xl mx-auto py-20">
        <div class="space-y-8 text-white text-lg md:text-xl px-4">
          <p>{t("ally.description.p1")}</p>
          <p>{t("ally.description.p2")}</p>
          <p>{t("ally.description.p3")}</p>
        </div>
      </div>
    </div>

    <div
      class="bg-brand-light bg-[url('/cuesta-del-viento/white-wave-contrast-2.png')] bg-size-[42px_auto]"
    >
      <div class="text-brand-blue drop-shadow-xs drop-shadow-brand-blue">
        <AboutUsUnderSeparator />
      </div>

      <div class="max-w-7xl mx-auto px-4 md:px-10 py-10">
        <div class="py-10 space-y-20">
          {
            alliesByCategory.map((category) => (
              <section class="space-y-4">
                <h2 class="text-3xl md:text-4xl font-bold text-brand-blue">
                  {category.label}
                </h2>

                <div class="grid md:grid-cols-2 items-start gap-10">
                  {category.allies.map((ally, index) => (
                    <article class="relative rounded-2xl bg-white text-brand-blue shadow-news-card">
                      {ally.image !== undefined && (
                        <div class="relative h-80 w-full">
                          <picture>
                            {/* WebP - good compression with broad support */}
                            <source
                              type="image/webp"
                              srcset={generateSrcSet(ally.image, "webp")}
                              sizes="(max-width: 768px) 100vw, 50vw"
                            />
                            {/* Fallback */}
                            <img
                              src={getOptimizedImageUrl(ally.image, 800)}
                              srcset={generateSrcSet(ally.image)}
                              sizes="(max-width: 768px) 100vw, 50vw"
                              alt={ally.image.alt || ally.title}
                              width="800"
                              height="800"
                              loading={index < 2 ? "eager" : "lazy"}
                              fetchpriority={index === 0 ? "high" : "auto"}
                              decoding={index < 2 ? "sync" : "async"}
                              class="object-cover w-full h-full rounded-t-2xl"
                            />
                          </picture>
                        </div>
                      )}

                      {(ally.whatsappLink !== undefined ||
                        ally.link !== undefined) && (
                        <div class="absolute top-[300px] right-4 flex gap-2 items-center">
                          {ally.whatsappLink !== undefined && (
                            <div class="bg-brand-red border-4 border-white size-10 rounded-full text-white flex items-center justify-center">
                              <a
                                href={ally.whatsappLink}
                                target="_blank"
                                rel="noopener noreferrer"
                                aria-label={`Ingresar en WhatsApp con ${ally.title}`}
                              >
                                <div class="whatsapp-btn flex items-center justify-center">
                                  <Icon name="whatsapp" />
                                </div>
                              </a>
                            </div>
                          )}

                          {ally.link !== undefined && (
                            <div class="bg-brand-red border-4 border-white size-10 rounded-full text-white flex items-center justify-center">
                              <a
                                href={ally.link}
                                target="_blank"
                                rel="noopener noreferrer"
                                aria-label={`Visitar sitio web de ${ally.title}`}
                              >
                                {/* Inline SVG - replaces astro-icon dependency */}
                                <svg
                                  xmlns="http://www.w3.org/2000/svg"
                                  width="20"
                                  height="20"
                                  viewBox="0 0 24 24"
                                  fill="none"
                                  stroke="currentColor"
                                  stroke-width="2"
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  aria-hidden="true"
                                >
                                  <path d="M7 7h10v10" />
                                  <path d="M7 17 17 7" />
                                </svg>
                              </a>
                            </div>
                          )}
                        </div>
                      )}

                      <div class="p-4 md:p-6 space-y-4">
                        <h3 class="text-2xl font-bold">{ally.title}</h3>
                        <p>{ally.description}</p>

                        {ally.discount !== undefined && (
                          <div>
                            <span class="py-2 px-4 bg-brand-light text-brand-blue rounded-2xl">
                              {ally.discount?.value}
                            </span>
                          </div>
                        )}

                        {ally.phone !== undefined && (
                          <div>
                            <span class="pr-2">Teléfono:</span>
                            <a
                              href={`tel:${ally.phone}`}
                              class="hover:underline"
                            >
                              {ally.phone}
                            </a>
                          </div>
                        )}
                      </div>
                    </article>
                  ))}
                </div>
              </section>
            ))
          }
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>
