---
import { Image } from "astro:assets";
import logo from "../assets/logos/logo-blanco-03.png";
import { useTranslations } from "../i18n/utils";
import LanguagePicker from "./language-picker.astro";
import { Icon } from "astro-icon/components";
import { storeUrl } from "../modules/store/constants";

const lang = Astro.params.locale as "en" | "es";
const t = useTranslations(lang);

const links = [
  { name: t("nav.services"), href: `/${lang}/services/clases` },
  { name: t("nav.about"), href: `/${lang}/about-us` },
  { name: t("nav.spot"), href: `/${lang}/cuesta-del-viento` },
  { name: t("nav.benefits"), href: `/${lang}/benefits` },
  { name: t("nav.news"), href: `/${lang}/news` },
  {
    name: t("nav.store"),
    href: storeUrl,
    props: { target: "_blank", rel: "noopener noreferrer" },
  },
];
---

<nav
  class="fixed top-0 left-0 right-0 z-50 h-20 bg-[rgba(0,0,0,0.1)] border-b border-white"
  style="backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-white font-bold">
    <div class="h-20 flex justify-between">
      <div class="flex items-center justify-between">
        <a href={`/${lang}/`}>
          <div
            class="relative w-full max-w-[100px] md:max-w-[130px] aspect-[3.45/1] flex items-center justify-center"
          >
            <Image decoding="async" src={logo} alt="Logo FaunaKite white" />
          </div>
        </a>
      </div>

      <div class="hidden md:flex items-center gap-12 uppercase">
        {
          links.map((link) => (
            <a
              class="hover:text-brand-red hover:text-shadow-none text-shadow-md"
              href={link.href}
              {...link.props}
            >
              {link.name}
            </a>
          ))
        }
        <LanguagePicker />
      </div>

      <div class="flex items-center gap-4 md:hidden">
        <LanguagePicker />

        <button
          id="mobile-menu-button"
          class="inline-flex items-center justify-center p-2 rounded-md text-white"
          aria-label="Open menu"
          aria-expanded="false"
        >
          <Icon name="hamburger" class="size-8" />
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu Overlay -->
  <div
    id="mobile-menu"
    class="invisible opacity-0 fixed inset-0 bg-brand-blue text-white z-40 md:hidden h-dvh transition-opacity duration-300 ease-out"
  >
    <div class="flex gap-10 flex-col h-full">
      <!-- Mobile Menu Header -->
      <div
        class="flex justify-between items-center h-20 shrink-0 px-4 border-b border-white"
      >
        <a href="/">
          <div
            class="relative w-full max-w-[100px] aspect-[3.45/1] flex items-center justify-center"
          >
            <Image
              decoding="async"
              src={logo}
              alt="Logo FaunaKite white icon"
            />
          </div>
        </a>
        <button
          id="mobile-menu-close"
          class="p-2 rounded-md text-white hover:text-gray-900 hover:bg-gray-100 transition-colors"
          aria-label="Close menu"
        >
          <Icon name="cross" class="size-8" />
        </button>
      </div>

      <!-- Mobile Menu Links -->
      <div
        id="mobile-menu-links"
        class="flex flex-col px-4 gap-10 font-bold uppercase opacity-0 scale-95 transition-all duration-300 ease-out"
      >
        {links.map((link) => <a href={link.href}>{link.name}</a>)}
      </div>
    </div>
  </div>

  <script>
    function initMobileMenu() {
      const menuButton = document.getElementById("mobile-menu-button");
      const menuClose = document.getElementById("mobile-menu-close");
      const mobileMenu = document.getElementById("mobile-menu");
      const mobileMenuLinks = document.getElementById("mobile-menu-links");
      const menuLinks = mobileMenu?.querySelectorAll("a");

      if (!menuButton || !mobileMenu) {
        return;
      }

      // Clean up any existing listeners by cloning and replacing
      const newMenuButton = menuButton.cloneNode(true);
      menuButton.parentNode?.replaceChild(newMenuButton, menuButton);

      const newMenuClose = menuClose?.cloneNode(true);
      if (menuClose && newMenuClose) {
        menuClose.parentNode?.replaceChild(newMenuClose, menuClose);
      }

      function openMenu() {
        mobileMenu.classList.remove("invisible", "opacity-0");
        mobileMenu.classList.add("visible", "opacity-100");

        setTimeout(() => {
          mobileMenuLinks?.classList.remove("opacity-0", "scale-95");
          mobileMenuLinks?.classList.add("opacity-100", "scale-100");
        }, 50);

        newMenuButton.setAttribute("aria-expanded", "true");
        document.body.style.overflow = "hidden";
      }

      function closeMenu() {
        mobileMenuLinks?.classList.remove("opacity-100", "scale-100");
        mobileMenuLinks?.classList.add("opacity-0", "scale-95");

        setTimeout(() => {
          mobileMenu.classList.remove("visible", "opacity-100");
          mobileMenu.classList.add("invisible", "opacity-0");
        }, 300);

        newMenuButton.setAttribute("aria-expanded", "false");
        document.body.style.overflow = "";
      }

      newMenuButton.addEventListener("click", openMenu);
      newMenuClose?.addEventListener("click", closeMenu);

      menuLinks?.forEach((link) => {
        link.addEventListener("click", closeMenu);
      });

      const escapeHandler = (e: KeyboardEvent) => {
        if (e.key === "Escape" && mobileMenu.classList.contains("visible")) {
          closeMenu();
        }
      };

      document.addEventListener("keydown", escapeHandler);

      // Cleanup function
      return () => {
        document.removeEventListener("keydown", escapeHandler);
      };
    }

    // Initialize
    let cleanup = initMobileMenu();

    // Re-initialize on page load (for View Transitions)
    document.addEventListener("astro:page-load", () => {
      cleanup?.();
      cleanup = initMobileMenu();
    });

    // Cleanup before navigation
    document.addEventListener("astro:before-preparation", () => {
      cleanup?.();
    });
  </script>
</nav>
