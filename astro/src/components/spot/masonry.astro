---
import { useTranslations } from "../../i18n/utils";

// MasonryGallery.astro
interface Props {
  verticalImages: {
    srcDesktop: string;
    srcMobile: string;
    alt: string;
    width: number;
    height: number;
  }[];
  horizontalImages: {
    srcDesktop: string;
    srcMobile: string;
    alt: string;
    width: number;
    height: number;
  }[];
}

const { verticalImages, horizontalImages } = Astro.props;

// Smarter distribution to avoid gaps in 3-column layout
// Strategy: Place verticals in groups of 3, then insert horizontals between groups
const combinedImages = [];

// Calculate optimal grouping
const totalVerticals = verticalImages.length;
const totalHorizontals = horizontalImages.length;

let vIndex = 0;
let hIndex = 0;

// Pattern: V-V-V-H or V-H-V depending on availability
// This ensures verticals can fill a complete 3-column row before horizontals create gaps
while (vIndex < totalVerticals || hIndex < totalHorizontals) {
  // Add 2 verticals
  if (vIndex < totalVerticals) {
    combinedImages.push({ ...verticalImages[vIndex], type: "vertical" });
    vIndex++;
  }
  if (vIndex < totalVerticals) {
    combinedImages.push({ ...verticalImages[vIndex], type: "vertical" });
    vIndex++;
  }

  // Add 1 horizontal (takes 2 columns)
  if (hIndex < totalHorizontals) {
    combinedImages.push({ ...horizontalImages[hIndex], type: "horizontal" });
    hIndex++;
  }

  // Add 1 more vertical to complete the row
  if (vIndex < totalVerticals) {
    combinedImages.push({ ...verticalImages[vIndex], type: "vertical" });
    vIndex++;
  }
}

// Generate unique ID for this instance
const galleryId = `masonry-${Math.random().toString(36).substr(2, 9)}`;

const lang = Astro.params.locale as "en" | "es";
const t = useTranslations(lang);
---

<div class="masonry-wrapper relative">
  <div
    id={galleryId}
    class="masonry-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 auto-rows-[150px] grid-flow-dense overflow-hidden"
    style="max-height: 750px;"
  >
    {
      combinedImages.map((image) => (
        <div
          class:list={[
            "group relative overflow-hidden rounded-xl",
            image.type === "vertical" && "row-span-3",
            image.type === "horizontal" &&
              "col-span-1 md:col-span-2 row-span-2",
          ]}
        >
          <picture class="block w-full h-full">
            <source media="(max-width: 768px)" srcset={image.srcMobile} />
            <source media="(min-width: 769px)" srcset={image.srcDesktop} />
            <img
              src={image.srcDesktop}
              alt={image.alt}
              width={image.width}
              height={image.height}
              loading="lazy"
              decoding="async"
              class="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-110"
              style="content-visibility: auto;"
            />
          </picture>
        </div>
      ))
    }
  </div>

  <!-- Expand button -->
  <div
    id={`${galleryId}-button-wrapper`}
    class="flex justify-center mt-6 transition-opacity duration-300"
  >
    <button
      id={`${galleryId}-button`}
      class="px-8 py-3 bg-brand-blue cursor-pointer text-white font-medium rounded-full shadow-lg transition"
      aria-label="Show all photos"
    >
      {t("the-spot.masonry.button")}
    </button>
  </div>
</div>

<script define:vars={{ galleryId }}>
  document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById(galleryId);
    const button = document.getElementById(`${galleryId}-button`);
    const buttonWrapper = document.getElementById(
      `${galleryId}-button-wrapper`,
    );

    if (!grid || !button || !buttonWrapper) return;

    button.addEventListener("click", () => {
      // Instantly remove height constraint
      grid.style.maxHeight = "none";

      // Fade out and remove button
      buttonWrapper.style.opacity = "0";
      setTimeout(() => buttonWrapper.remove(), 300);
    });
  });
</script>

<style>
  /* Smooth fade-in for images */
  img {
    opacity: 0;
    animation: fadeIn 0.6s ease-in forwards;
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }

  /* Prevent layout shift with skeleton background */
  img {
    background: linear-gradient(110deg, #1f2937 8%, #374151 18%, #1f2937 33%);
    background-size: 200% 100%;
  }
</style>
